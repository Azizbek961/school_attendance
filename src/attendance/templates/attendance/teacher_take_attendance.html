<!-- attendance/templates/attendance/teacher_take_attendance.html -->
{% extends 'attendance/base.html' %}

{% block title %}Davomat olish - SAMO School{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="card">
        <div class="card-header bg-success text-white">
            <h5 class="card-title mb-0">
                <i class="fas fa-clipboard-check me-2"></i>Davomat olish
            </h5>
        </div>
        <div class="card-body">
            <div class="row mb-4">
                <div class="col-md-8">
                    <h4>{{ class_obj.name }} sinfi</h4>
                    <h5>{{ subject.name }} fanidan davomat</h5>
                    <p class="text-muted mb-0">
                        <i class="fas fa-calendar-day me-1"></i>
                        Sana: {{ today|date:"d.m.Y" }}
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-primary" onclick="markAll('present')">
                            <i class="fas fa-check-circle me-1"></i>Hammasi qatnashdi
                        </button>
                        <button type="button" class="btn btn-outline-danger" onclick="markAll('absent')">
                            <i class="fas fa-times-circle me-1"></i>Hammasi qatnashmadi
                        </button>
                    </div>
                </div>
            </div>

            <form method="POST" id="attendanceForm">
                {% csrf_token %}
                <input type="hidden" name="date" value="{{ today|date:'Y-m-d' }}">

                <div class="table-responsive">
                    <table class="table table-hover" id="attendanceTable">
                        <thead class="table-light">
                            <tr>
                                <th width="5%">#</th>
                                <th>O'quvchi</th>
                                <th width="20%">Holat</th>
                                <th width="30%">Izoh</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for profile in students %}
                            {% with student=profile.user %}
                            {% with existing=existing_attendance|dict_key:student.id %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>
                                    <strong>{{ student.get_full_name }}</strong>
                                    <br>
                                    <small class="text-muted">@{{ student.username }}</small>
                                </td>
                                <td>
                                    <select name="status_{{ student.id }}"
                                            class="form-select status-select"
                                            data-student-id="{{ student.id }}"
                                            onchange="updateRowColor(this)">
                                        <option value="present" {% if existing and existing.status == 'present' %}selected{% endif %}>
                                            ‚úÖ Qatnashdi
                                        </option>
                                        <option value="absent" {% if existing and existing.status == 'absent' %}selected{% endif %}>
                                            ‚ùå Qatnashmadi
                                        </option>
                                        <option value="late" {% if existing and existing.status == 'late' %}selected{% endif %}>
                                            ‚è∞ Kech qoldi
                                        </option>
                                        <option value="excused" {% if existing and existing.status == 'excused' %}selected{% endif %}>
                                            üìù Sababli
                                        </option>
                                    </select>
                                </td>
                                <td>
                                    <textarea name="notes_{{ student.id }}"
                                              class="form-control notes-input"
                                              rows="1"
                                              placeholder="Izoh (ixtiyoriy)">{{ existing.notes|default:'' }}</textarea>
                                </td>
                            </tr>
                            {% endwith %}
                            {% endwith %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="attendance-summary" id="attendanceSummary">
                            <!-- Summary will be updated by JavaScript -->
                        </div>
                    </div>
                    <div class="col-md-6 text-end">
                        <a href="{% url 'teacher_my_classes' %}" class="btn btn-secondary me-2">
                            <i class="fas fa-times me-1"></i>Bekor qilish
                        </a>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save me-1"></i>Davomatni saqlash
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.table th {
    position: sticky;
    top: 0;
    background: #f8f9fa;
}

.status-select {
    min-width: 120px;
}

.notes-input {
    font-size: 14px;
    resize: vertical;
}

tr.present-row {
    background-color: rgba(40, 167, 69, 0.1) !important;
}

tr.absent-row {
    background-color: rgba(220, 53, 69, 0.1) !important;
}

tr.late-row {
    background-color: rgba(255, 193, 7, 0.1) !important;
}

tr.excused-row {
    background-color: rgba(23, 162, 184, 0.1) !important;
}

.attendance-summary {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 15px;
}

.summary-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
}

.summary-count {
    font-weight: 600;
}
</style>

<script>
function updateRowColor(selectElement) {
    const row = selectElement.closest('tr');
    const status = selectElement.value;

    // Remove all status classes
    row.classList.remove('present-row', 'absent-row', 'late-row', 'excused-row');

    // Add appropriate class
    switch(status) {
        case 'present': row.classList.add('present-row'); break;
        case 'absent': row.classList.add('absent-row'); break;
        case 'late': row.classList.add('late-row'); break;
        case 'excused': row.classList.add('excused-row'); break;
    }

    updateSummary();
}

function markAll(status) {
    document.querySelectorAll('.status-select').forEach(select => {
        select.value = status;
        updateRowColor(select);
    });
}

function updateSummary() {
    const counts = {
        present: 0,
        absent: 0,
        late: 0,
        excused: 0
    };

    document.querySelectorAll('.status-select').forEach(select => {
        counts[select.value]++;
    });

    const total = Object.values(counts).reduce((a, b) => a + b, 0);

    document.getElementById('attendanceSummary').innerHTML = `
        <h6>Davomat statistikasi:</h6>
        <div class="summary-item">
            <span>Qatnashgan:</span>
            <span class="summary-count text-success">${counts.present}</span>
        </div>
        <div class="summary-item">
            <span>Qatnashmagan:</span>
            <span class="summary-count text-danger">${counts.absent}</span>
        </div>
        <div class="summary-item">
            <span>Kech qolgan:</span>
            <span class="summary-count text-warning">${counts.late}</span>
        </div>
        <div class="summary-item">
            <span>Sababli:</span>
            <span class="summary-count text-info">${counts.excused}</span>
        </div>
        <div class="summary-item mt-2 pt-2 border-top">
            <strong>Jami:</strong>
            <strong class="summary-count">${total}</strong>
        </div>
    `;
}

// Initialize row colors and summary on page load
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.status-select').forEach(select => {
        updateRowColor(select);
    });
    updateSummary();
});

// Auto-save feature (optional)
let autoSaveTimer;
document.querySelectorAll('.status-select, .notes-input').forEach(element => {
    element.addEventListener('change', function() {
        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(() => {
            // You could implement auto-save here if needed
        }, 2000);
    });
});
</script>
{% endblock %}