{% extends 'attendance/base_admin.html' %}

{% block title %}Davomatni Tahrirlash - SAMO School{% endblock %}
{% block page_title %}Davomatni Tahrirlash{% endblock %}
{% block page_subtitle %}{{ attendance.student.get_full_name }}ning davomatini tahrirlash{% endblock %}

{% block content %}
<div class="dashboard-card">
    <div class="card-header">
        <h3>Davomat Ma'lumotlarini Tahrirlash</h3>
        <a href="{% url 'manage_attendance' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Orqaga
        </a>
    </div>

    <div class="card-body">
        <form method="post" class="needs-validation" novalidate>
            {% csrf_token %}

            {% if messages %}
            <div class="messages mb-4">
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Davomat ma'lumotlari -->
            <div class="attendance-info mb-5">
                <h4 class="section-title">Davomat Ma'lumotlari</h4>
                <div class="row">
                    <div class="col-md-6">
                        <div class="info-item">
                            <span class="info-label">O'quvchi:</span>
                            <span class="info-value">{{ attendance.student.get_full_name }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Sinf:</span>
                            <span class="info-value">{{ attendance.class_obj.name }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Fan:</span>
                            <span class="info-value">{{ attendance.subject.name }}</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-item">
                            <span class="info-label">Sana:</span>
                            <span class="info-value">{{ attendance.date|date:"d.m.Y" }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">O'qituvchi:</span>
                            <span class="info-value">{{ attendance.teacher.get_full_name|default:"Tayinlanmagan" }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Qayd etilgan:</span>
                            <span class="info-value">{{ attendance.created_at|date:"d.m.Y H:i" }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tahrirlash formasi -->
            <div class="edit-form-section">
                <h4 class="section-title">Davomat Holatini O'zgartirish</h4>

                <div class="row g-4">
                    <!-- Holat tanlovi -->
                    <div class="col-12">
                        <label class="form-label">Davomat Holati *</label>
                        <div class="attendance-status-options">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <div class="status-option present">
                                        <input type="radio" class="btn-check" name="status"
                                               id="status_present" value="present"
                                               {% if attendance.status == 'present' %}checked{% endif %} required>
                                        <label class="btn btn-outline-success w-100" for="status_present">
                                            <i class="fas fa-check-circle"></i>
                                            <span>Bor</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="status-option absent">
                                        <input type="radio" class="btn-check" name="status"
                                               id="status_absent" value="absent"
                                               {% if attendance.status == 'absent' %}checked{% endif %}>
                                        <label class="btn btn-outline-danger w-100" for="status_absent">
                                            <i class="fas fa-times-circle"></i>
                                            <span>Yo'q</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="status-option late">
                                        <input type="radio" class="btn-check" name="status"
                                               id="status_late" value="late"
                                               {% if attendance.status == 'late' %}checked{% endif %}>
                                        <label class="btn btn-outline-warning w-100" for="status_late">
                                            <i class="fas fa-clock"></i>
                                            <span>Kechikdi</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="status-option excused">
                                        <input type="radio" class="btn-check" name="status"
                                               id="status_excused" value="excused"
                                               {% if attendance.status == 'excused' %}checked{% endif %}>
                                        <label class="btn btn-outline-info w-100" for="status_excused">
                                            <i class="fas fa-notes-medical"></i>
                                            <span>Sababli</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Izoh maydoni -->
                    <div class="col-12">
                        <label for="notes" class="form-label">Izoh</label>
                        <textarea class="form-control" id="notes" name="notes"
                                  rows="4" placeholder="Izohni kiriting (ixtiyoriy)">{{ attendance.notes|default:"" }}</textarea>
                        <div class="form-text">Davomat holatiga oid qo'shimcha ma'lumot</div>
                    </div>

                    <!-- Tarix ma'lumotlari -->
                    <div class="col-12">
                        <div class="history-card">
                            <h5>Tarix Ma'lumotlari</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="history-item">
                                        <span class="history-label">Yaratilgan:</span>
                                        <span class="history-value">{{ attendance.created_at|date:"d.m.Y H:i" }}</span>
                                    </div>
                                    <div class="history-item">
                                        <span class="history-label">Yaratuvchi:</span>
                                        <span class="history-value">{{ attendance.teacher.get_full_name|default:"Noma'lum" }}</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="history-item">
                                        <span class="history-label">Yangilangan:</span>
                                        <span class="history-value">{{ attendance.updated_at|date:"d.m.Y H:i" }}</span>
                                    </div>
                                    <div class="history-item">
                                        <span class="history-label">Holat:</span>
                                        <span class="history-value">
                                            {% if attendance.status == 'present' %}
                                                <span class="badge bg-success">Bor</span>
                                            {% elif attendance.status == 'absent' %}
                                                <span class="badge bg-danger">Yo'q</span>
                                            {% elif attendance.status == 'late' %}
                                                <span class="badge bg-warning">Kechikdi</span>
                                            {% elif attendance.status == 'excused' %}
                                                <span class="badge bg-info">Sababli</span>
                                            {% endif %}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Xavfli amallar -->
            <div class="danger-actions-section mt-5">
                <h4 class="section-title text-danger">Xavfli Amallar</h4>
                <div class="alert alert-warning">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle me-3 fs-4"></i>
                        <div>
                            <h5>Diqqat!</h5>
                            <p class="mb-2">Quyidagi amal davomat yozuvini butunlay o'chirib yuboradi:</p>
                            <a href="{% url 'delete_attendance' attendance.id %}" class="btn btn-outline-danger btn-sm"
                               onclick="return confirm('Bu davomat yozuvini oÊ»chirishni tasdiqlaysizmi? Ushbu amalni bekor qilib bo\'lmaydi.')">
                                <i class="fas fa-trash"></i> Davomat yozuvini o'chirish
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form amallari -->
            <div class="form-actions mt-5">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-save"></i> O'zgarishlarni Saqlash
                </button>
                <a href="{% url 'manage_attendance' %}" class="btn btn-secondary btn-lg">
                    <i class="fas fa-times"></i> Bekor Qilish
                </a>
                <button type="button" class="btn btn-outline-primary btn-lg" id="viewOriginalBtn">
                    <i class="fas fa-history"></i> Asl holatni ko'rish
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Original State Modal -->
<div class="modal fade" id="originalStateModal" tabindex="-1" aria-labelledby="originalStateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="originalStateModalLabel">Asl Davomat Holati</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="original-state">
                    <div class="info-item">
                        <span class="info-label">Holat:</span>
                        <span class="info-value">
                            {% if attendance.status == 'present' %}
                                <span class="badge bg-success">Bor</span>
                            {% elif attendance.status == 'absent' %}
                                <span class="badge bg-danger">Yo'q</span>
                            {% elif attendance.status == 'late' %}
                                <span class="badge bg-warning">Kechikdi</span>
                            {% elif attendance.status == 'excused' %}
                                <span class="badge bg-info">Sababli</span>
                            {% endif %}
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Izoh:</span>
                        <span class="info-value">{{ attendance.notes|default:"Izoh yo'q" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Yaratilgan:</span>
                        <span class="info-value">{{ attendance.created_at|date:"d.m.Y H:i" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Oxirgi yangilangan:</span>
                        <span class="info-value">{{ attendance.updated_at|date:"d.m.Y H:i" }}</span>
                    </div>
                </div>
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    Bu ma'lumotlar saqlanishidan oldingi asl holatni ko'rsatadi.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Yopish</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Form validation
document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('.needs-validation');
    Array.from(forms).forEach(form => {
        form.addEventListener('submit', event => {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);
    });

    // Status tanlovlariga visual effekt qo'shish
    const statusOptions = document.querySelectorAll('.status-option input[type="radio"]');
    statusOptions.forEach(option => {
        option.addEventListener('change', function() {
            // Barcha label lardan active class ni olib tashlash
            document.querySelectorAll('.status-option label').forEach(label => {
                label.classList.remove('active');
            });

            // Tanlangan label ga active class qo'shish
            const selectedLabel = document.querySelector(`label[for="${this.id}"]`);
            if (selectedLabel) {
                selectedLabel.classList.add('active');
            }
        });

        // Sahifa yuklanganda tanlangan statusni active qilish
        if (option.checked) {
            const selectedLabel = document.querySelector(`label[for="${option.id}"]`);
            if (selectedLabel) {
                selectedLabel.classList.add('active');
            }
        }
    });

    // Asl holatni ko'rish tugmasi
    const viewOriginalBtn = document.getElementById('viewOriginalBtn');
    if (viewOriginalBtn) {
        viewOriginalBtn.addEventListener('click', function() {
            const modal = new bootstrap.Modal(document.getElementById('originalStateModal'));
            modal.show();
        });
    }

    // Izoh maydoni avtomatik o'lchami
    const notesTextarea = document.getElementById('notes');
    if (notesTextarea) {
        // Auto-resize
        notesTextarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        // Dastlabki o'lchamni sozlash
        notesTextarea.style.height = 'auto';
        notesTextarea.style.height = (notesTextarea.scrollHeight) + 'px';
    }

    // Form yuborilganda yuklash holatini ko'rsatish
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function() {
            const submitBtn = this.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saqlanmoqda...';
                submitBtn.disabled = true;
            }
        });
    }
});

// Status o'zgartirilganda ogohlantirish
document.addEventListener('DOMContentLoaded', function() {
    let originalStatus = null;
    const statusRadios = document.querySelectorAll('input[name="status"]:checked');
    if (statusRadios.length > 0) {
        originalStatus = statusRadios[0].value;
    }

    document.querySelectorAll('input[name="status"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value !== originalStatus) {
                // Status o'zgartirilganini bildiruvchi xabar
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-info alert-dismissible fade show mt-3';
                alertDiv.innerHTML = `
                    <i class="fas fa-info-circle me-2"></i>
                    Davomat holati o'zgartirildi: <strong>${getStatusDisplay(originalStatus)}</strong> dan <strong>${getStatusDisplay(this.value)}</strong> ga
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;

                // Eski xabarlarni olib tashlash
                const existingAlerts = document.querySelectorAll('.alert.alert-info.mt-3');
                existingAlerts.forEach(alert => alert.remove());

                // Yangi xabarni qo'shish
                const editFormSection = document.querySelector('.edit-form-section');
                if (editFormSection) {
                    editFormSection.appendChild(alertDiv);
                }
            }
        });
    });

    function getStatusDisplay(status) {
        const statusMap = {
            'present': 'Bor',
            'absent': 'Yo\'q',
            'late': 'Kechikdi',
            'excused': 'Sababli'
        };
        return statusMap[status] || status;
    }
});
</script>

<style>
/* Custom styles for edit_attendance.html */
.section-title {
    font-size: 1.2rem;
    color: #2c3e50;
    border-bottom: 2px solid #3498db;
    padding-bottom: 0.5rem;
    margin-bottom: 1.5rem;
}

.section-title.text-danger {
    border-bottom-color: #e74c3c;
    color: #e74c3c;
}

.attendance-info {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    border: 1px solid #dee2e6;
}

.info-item {
    margin-bottom: 15px;
    display: flex;
    align-items: center;
}

.info-label {
    font-weight: 600;
    color: #2c3e50;
    min-width: 150px;
}

.info-value {
    color: #34495e;
    flex: 1;
}

.attendance-status-options {
    margin-bottom: 20px;
}

.status-option label {
    padding: 15px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    transition: all 0.3s ease;
    border-width: 2px;
}

.status-option label i {
    font-size: 24px;
    margin-bottom: 8px;
}

.status-option label span {
    font-weight: 600;
    font-size: 14px;
}

.status-option label.active {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.status-option.present label.active {
    background: #2ecc71;
    color: white;
    border-color: #2ecc71;
}

.status-option.absent label.active {
    background: #e74c3c;
    color: white;
    border-color: #e74c3c;
}

.status-option.late label.active {
    background: #f39c12;
    color: white;
    border-color: #f39c12;
}

.status-option.excused label.active {
    background: #3498db;
    color: white;
    border-color: #3498db;
}

.history-card {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin-top: 20px;
}

.history-card h5 {
    color: #2c3e50;
    margin-bottom: 15px;
    font-size: 1.1rem;
}

.history-item {
    margin-bottom: 10px;
    display: flex;
    align-items: center;
}

.history-label {
    font-weight: 600;
    color: #2c3e50;
    min-width: 120px;
}

.history-value {
    color: #34495e;
    flex: 1;
}

.danger-actions-section .alert-warning {
    background-color: #fff3cd;
    border-color: #ffeaa7;
    color: #856404;
}

.danger-actions-section .alert-warning h5 {
    color: #856404;
}

.form-actions {
    display: flex;
    justify-content: flex-start;
    gap: 1rem;
    border-top: 1px solid #dee2e6;
    padding-top: 2rem;
}

/* Modal styles */
.original-state {
    padding: 10px;
}

.original-state .info-item {
    margin-bottom: 12px;
}

.original-state .info-label {
    min-width: 120px;
}

/* Form validation */
.was-validated .form-control:invalid {
    border-color: #e74c3c;
}

.was-validated .form-control:valid {
    border-color: #2ecc71;
}

.was-validated input:invalid ~ label.btn {
    border-color: #e74c3c;
}

.was-validated input:valid ~ label.btn {
    border-color: #2ecc71;
}

/* Responsive */
@media (max-width: 768px) {
    .form-actions {
        flex-direction: column;
        align-items: stretch;
    }

    .form-actions .btn {
        width: 100%;
        margin-bottom: 10px;
    }

    .info-item, .history-item {
        flex-direction: column;
        align-items: flex-start;
    }

    .info-label, .history-label {
        margin-bottom: 5px;
        min-width: 100%;
    }

    .status-option label {
        padding: 10px;
    }

    .status-option label i {
        font-size: 20px;
        margin-bottom: 5px;
    }
}

/* Textarea auto-resize */
textarea.form-control {
    resize: none;
    overflow: hidden;
    min-height: 100px;
    transition: height 0.2s ease;
}

/* Loading animation */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.fa-spinner {
    animation: spin 1s linear infinite;
}
</style>
{% endblock %}